{{define "order_modal.html"}}
<div class="modal modal-modern order-modal" hx-ext="sse" sse-connect="/kitchen/events" data-order-id="{{.Order.ID}}">
    <!-- SSE update target -->
    <div id="order-modal-sse-updates" sse-swap="order-item-update" hx-swap="beforeend" style="display:none;"></div>

    <div class="modal-backdrop" onclick="this.closest('.modal').remove()"></div>
    <div class="modal-dialog modal-dialog-modern order-modal-dialog">
        <div class="modal-header modal-header-modern">
            <div>
                <h2 class="modal-title">Order {{.Order.ShortID}}</h2>
                <p class="order-modal-subtitle">Table {{.Order.TableNumber}} ¬∑ {{.Order.ItemsCount}} items</p>
            </div>
            <button type="button" class="modal-close modal-close-modern" onclick="this.closest('.modal').remove()">
                <span>&times;</span>
            </button>
        </div>

        <div class="order-modal-summary">
            <div class="order-card-header">
                <div>
                    <div class="order-id">Table {{.Order.TableNumber}}</div>
                    <div class="order-table">Last update {{.Order.UpdatedAt}}</div>
                </div>
                <div class="order-card-metrics">
                    <span class="status-badge {{.Order.StatusClass}}">{{.Order.StatusLabel}}</span>
                    <span class="order-total">{{.Order.Total}}</span>
                </div>
            </div>
            <div class="order-card-stats">
                <div class="order-stat">
                    <span class="order-stat-label">Items</span>
                    <span class="order-stat-value">{{.Order.ItemsCount}}</span>
                </div>
                <div class="order-stat">
                    <span class="order-stat-label">Kitchen flow</span>
                    <span class="order-stat-value">{{.Order.PrepSummary}}</span>
                </div>
                {{if .Order.NonPrepSummary}}
                <div class="order-stat">
                    <span class="order-stat-label">Add-ons</span>
                    <span class="order-stat-value">{{.Order.NonPrepSummary}}</span>
                </div>
                {{end}}
            </div>
        </div>

        <div class="order-card-details order-modal-content">
            <div class="order-detail-actions">
                {{if ne .Order.Status "closed"}}
                <button type="button"
                        class="order-action-btn"
                        hx-get="/orders/{{.Order.ID}}/items/new"
                        hx-target="#modal-root"
                        hx-swap="innerHTML">
                    ‚ûï Add Item
                </button>
                <button type="button"
                        class="order-action-btn order-action-secondary"
                        hx-get="/orders/{{.Order.ID}}/groups/new"
                        hx-target="#modal-root"
                        hx-swap="innerHTML">
                    üßæ New Group
                </button>
                <button type="button"
                        class="order-action-btn order-action-close"
                        onclick="closeOrder('{{.Order.ID}}')">
                    ‚úì Close Order
                </button>
                {{else if eq .Order.TableStatus "clearing"}}
                <div class="order-closed-notice">
                    <span class="status-badge status-closed">Order Closed</span>
                    <span class="clearing-notice">Table pending release (takeaway items)</span>
                </div>
                <button type="button"
                        class="order-action-btn order-action-release"
                        onclick="releaseTable('{{.Order.TableID}}')">
                    ‚úì Release Table
                </button>
                {{else}}
                <div class="order-closed-notice">
                    <span class="status-badge status-closed">Order Closed</span>
                </div>
                {{end}}
            </div>

            {{if .Order.Groups}}
            {{range .Order.Groups}}
            {{if .ItemCount}}
            <div class="order-group">
                <div class="order-group-header">
                    <div>
                        <span class="order-group-name">Group {{.Name}}</span>
                        <span class="order-group-meta">{{.ItemCount}} items ¬∑ {{.Total}}</span>
                    </div>
                </div>
                <div class="order-items">
                    {{range .Items}}
                    <div class="order-item-row" data-item-id="{{.ID}}" data-status="{{.Status}}">
                        <div class="order-item-info">
                            <div class="order-item-name">{{.DishName}}</div>
                            <div class="order-item-meta">
                                <span class="order-item-status {{.StatusClass}}">{{.StatusLabel}}</span>
                                {{if .RequiresProduction}}
                                <span class="order-item-tag">Kitchen</span>
                                {{else}}
                                <span class="order-item-tag order-item-tag-soft">Add-on</span>
                                {{end}}
                                {{if .Notes}}
                                <span class="order-item-notes">üìù {{.Notes}}</span>
                                {{end}}
                            </div>
                        </div>
                        <div class="order-item-qty">√ó{{.Quantity}}</div>
                        <div class="order-item-price">{{.Total}}</div>
                        <div class="order-item-actions">
                            {{if eq .Status "ready"}}
                            <button type="button" class="btn-item-action btn-deliver" onclick="markItemDelivered('{{.ID}}')">
                                üöÄ Deliver
                            </button>
                            {{else if eq .Status "pending"}}
                            <button type="button" class="btn-item-action btn-cancel" onclick="cancelOrderItem('{{.ID}}')">
                                ‚úï Cancel
                            </button>
                            {{end}}
                        </div>
                    </div>
                    {{end}}
                </div>
            </div>
            {{end}}
            {{end}}
            {{end}}

            {{if .Order.HasUngrouped}}
            <div class="order-group order-group-ungrouped">
                <div class="order-group-header">
                    <div>
                        <span class="order-group-name">Ungrouped</span>
                        <span class="order-group-meta">{{.Order.Ungrouped.ItemCount}} items ¬∑ {{.Order.Ungrouped.Total}}</span>
                    </div>
                </div>
                <div class="order-items">
                    {{range .Order.Ungrouped.Items}}
                    <div class="order-item-row" data-item-id="{{.ID}}" data-status="{{.Status}}">
                        <div class="order-item-info">
                            <div class="order-item-name">{{.DishName}}</div>
                            <div class="order-item-meta">
                                <span class="order-item-status {{.StatusClass}}">{{.StatusLabel}}</span>
                                {{if .RequiresProduction}}
                                <span class="order-item-tag">Kitchen</span>
                                {{else}}
                                <span class="order-item-tag order-item-tag-soft">Add-on</span>
                                {{end}}
                                {{if .Notes}}
                                <span class="order-item-notes">üìù {{.Notes}}</span>
                                {{end}}
                            </div>
                        </div>
                        <div class="order-item-qty">√ó{{.Quantity}}</div>
                        <div class="order-item-price">{{.Total}}</div>
                        <div class="order-item-actions">
                            {{if eq .Status "ready"}}
                            <button type="button" class="btn-item-action btn-deliver" onclick="markItemDelivered('{{.ID}}')">
                                üöÄ Deliver
                            </button>
                            {{else if eq .Status "pending"}}
                            <button type="button" class="btn-item-action btn-cancel" onclick="cancelOrderItem('{{.ID}}')">
                                ‚úï Cancel
                            </button>
                            {{end}}
                        </div>
                    </div>
                    {{end}}
                </div>
            </div>
            {{end}}

            {{if .Order.GroupTotals}}
            <div class="order-billing-summary">
                <div class="order-billing-header">
                    <h3>Billing Summary</h3>
                    <span class="order-billing-updated">Updated {{.Order.UpdatedAt}}</span>
                </div>
                <div class="order-billing-table">
                    {{range .Order.GroupTotals}}
                    <div class="order-billing-row">
                        <div class="order-billing-name">Group {{.Name}}</div>
                        <div class="order-billing-count">{{.ItemCount}} items</div>
                        <div class="order-billing-total">{{.Total}}</div>
                    </div>
                    {{end}}
                    <div class="order-billing-row order-billing-row-total">
                        <div class="order-billing-name">Order Total</div>
                        <div class="order-billing-count">{{.Order.ItemsCount}} items</div>
                        <div class="order-billing-total">{{.Order.Total}}</div>
                    </div>
                </div>
            </div>
            {{end}}

            <div class="order-activity">
                <h3>Recent Events</h3>
                {{if .Order.Events}}
                <ul class="order-activity-list">
                    {{range .Order.Events}}
                    <li>
                        <div class="order-activity-message">{{.Message}}</div>
                        <div class="order-activity-time">{{.Occurred}}</div>
                    </li>
                    {{end}}
                </ul>
                {{else}}
                <p class="order-activity-empty">No events recorded yet.</p>
                {{end}}
            </div>
        </div>
    </div>
</div>

<style>
.order-item-row {
    display: flex;
    align-items: center;
    gap: 16px;
}

.order-item-actions {
    margin-left: auto;
    display: flex;
    gap: 8px;
}

.btn-item-action {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
}

.btn-deliver {
    background: #10b981;
    color: white;
}

.btn-deliver:hover {
    background: #059669;
    transform: translateY(-1px);
}

.btn-cancel {
    background: #ef4444;
    color: white;
}

.btn-cancel:hover {
    background: #dc2626;
    transform: translateY(-1px);
}

.btn-item-action:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.item-status-badge {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    white-space: nowrap;
}

.status-delivered {
    background: #d1fae5;
    color: #065f46;
}

.status-cancelled {
    background: #fee2e2;
    color: #991b1b;
}

.order-action-close {
    background: #059669 !important;
    color: white !important;
    margin-left: auto;
}

.order-action-close:hover {
    background: #047857 !important;
}

/* Close confirmation modal */
.close-confirm-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.close-confirm-dialog {
    background: white;
    border-radius: 12px;
    padding: 24px;
    max-width: 400px;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
}

.close-confirm-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 12px;
}

.close-confirm-message {
    color: #6b7280;
    margin-bottom: 8px;
}

.close-confirm-warning {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: 8px;
    padding: 12px;
    margin: 16px 0;
    font-size: 14px;
}

.close-confirm-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 20px;
}

.close-confirm-btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    border: none;
}

.close-confirm-btn-cancel {
    background: #f3f4f6;
    color: #374151;
}

.close-confirm-btn-confirm {
    background: #059669;
    color: white;
}

/* Order closed notice */
.order-closed-notice {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: #f3f4f6;
    border-radius: 8px;
    flex: 1;
}

.clearing-notice {
    color: #92400e;
    font-size: 14px;
    font-weight: 500;
}

.order-action-release {
    background: #10b981 !important;
    color: white !important;
}

.order-action-release:hover {
    background: #059669 !important;
}
</style>

<script>
function markItemDelivered(itemID) {
    if (!confirm('Mark this item as delivered to the customer?')) {
        return;
    }

    fetch(`/api/order/items/${itemID}/deliver`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(res => {
        if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
        }
        // Update only the specific item's UI without reloading the entire modal
        const itemRow = document.querySelector(`.order-item-row[data-item-id="${itemID}"]`);
        if (itemRow) {
            // Update status attribute
            itemRow.dataset.status = 'delivered';

            // Update status badge if exists
            const statusBadge = itemRow.querySelector('.order-item-status');
            if (statusBadge) {
                statusBadge.textContent = 'Delivered';
                statusBadge.className = 'order-item-status status-delivered';
            }

            // Remove the deliver button
            const actionsDiv = itemRow.querySelector('.order-item-actions');
            if (actionsDiv) {
                actionsDiv.innerHTML = '<span class="text-success">‚úì Delivered</span>';
            }
        }
    })
    .catch(err => {
        console.error('Error marking item as delivered:', err);
        alert('Failed to mark item as delivered. Please try again.');
    });
}

function cancelOrderItem(itemID) {
    if (!confirm('Cancel this item? This action cannot be undone.')) {
        return;
    }

    fetch(`/api/order/items/${itemID}/cancel`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(res => {
        if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
        }
        // Refresh the modal
        const orderID = new URLSearchParams(window.location.search).get('order_id') ||
                        document.querySelector('[data-order-id]')?.dataset.orderId ||
                        document.querySelector('.modal-title')?.textContent.match(/Order (\S+)/)?.[1];

        if (orderID) {
            htmx.ajax('GET', `/orders/${orderID}/modal`, {target: '#modal-root', swap: 'innerHTML'});
        } else {
            location.reload();
        }
    })
    .catch(err => {
        console.error('Error canceling item:', err);
        alert('Failed to cancel item. Please try again.');
    });
}

function closeOrder(orderID) {
    // First, check if confirmation is needed
    fetch(`/api/order/${orderID}/close`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json().then(data => ({ ok: res.ok, data })))
    .then(({ ok, data }) => {
        if (!ok) {
            // Handle error response
            alert(data.error || 'Failed to close order');
            return;
        }
        // Check if the response indicates we need confirmation
        if (data.data && data.data.requires_confirmation) {
            showCloseConfirmation(
                orderID,
                data.data.pending_count || 0,
                data.data.ready_count || 0,
                data.data.preparing_count || 0
            );
        } else if (data.data && data.data.order) {
            // Order was closed successfully
            onOrderClosed(orderID, data.data.has_takeaway);
        } else if (data.error) {
            alert(data.error);
        }
    })
    .catch(err => {
        console.error('Error closing order:', err);
        alert('Failed to close order. Please try again.');
    });
}

function showCloseConfirmation(orderID, pendingCount, readyCount, preparingCount) {
    preparingCount = preparingCount || 0;

    // Build warning message
    let warningParts = [];
    if (preparingCount > 0) {
        warningParts.push(`<strong>${preparingCount}</strong> item(s) are being prepared`);
    }
    if (pendingCount > 0) {
        warningParts.push(`<strong>${pendingCount}</strong> pending item(s) will be cancelled`);
    }
    if (readyCount > 0) {
        warningParts.push(`<strong>${readyCount}</strong> ready item(s) will be marked as delivered`);
    }

    // If there are preparing items, show special dialog with Takeaway option
    const hasPreparing = preparingCount > 0;

    const overlay = document.createElement('div');
    overlay.className = 'close-confirm-overlay';
    overlay.id = 'close-confirm-overlay';

    if (hasPreparing) {
        overlay.innerHTML = `
            <div class="close-confirm-dialog">
                <div class="close-confirm-title">Items Being Prepared</div>
                <div class="close-confirm-message">There are items currently being prepared in the kitchen.</div>
                <div class="close-confirm-warning">
                    ${warningParts.join('<br>')}
                </div>
                <div class="close-confirm-message" style="margin-top: 12px;">
                    How do you want to handle the preparing items?
                </div>
                <div class="close-confirm-actions" style="flex-direction: column; gap: 8px;">
                    <button class="close-confirm-btn close-confirm-btn-takeaway" onclick="confirmCloseOrder('${orderID}', true)" style="width: 100%; background: #f59e0b;">
                        Takeaway - Customer takes food when ready
                    </button>
                    <button class="close-confirm-btn close-confirm-btn-cancel" onclick="dismissCloseConfirmation()" style="width: 100%;">
                        Go Back
                    </button>
                </div>
            </div>
        `;
    } else {
        overlay.innerHTML = `
            <div class="close-confirm-dialog">
                <div class="close-confirm-title">Close Order?</div>
                <div class="close-confirm-message">This will finalize the order and release the table.</div>
                <div class="close-confirm-warning">
                    ${warningParts.join('<br>')}
                </div>
                <div class="close-confirm-actions">
                    <button class="close-confirm-btn close-confirm-btn-cancel" onclick="dismissCloseConfirmation()">
                        Cancel
                    </button>
                    <button class="close-confirm-btn close-confirm-btn-confirm" onclick="confirmCloseOrder('${orderID}', false)">
                        Close Order
                    </button>
                </div>
            </div>
        `;
    }
    document.body.appendChild(overlay);
}

function dismissCloseConfirmation() {
    const overlay = document.getElementById('close-confirm-overlay');
    if (overlay) {
        overlay.remove();
    }
}

function confirmCloseOrder(orderID, takeaway) {
    dismissCloseConfirmation();

    let url = `/api/order/${orderID}/close?force=true`;
    if (takeaway) {
        url += '&takeaway=true';
    }

    fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(data => {
        if (data.data && data.data.order) {
            onOrderClosed(orderID, data.data.has_takeaway);
        } else if (data.error) {
            alert(data.error);
        }
    })
    .catch(err => {
        console.error('Error closing order:', err);
        alert('Failed to close order. Please try again.');
    });
}

function onOrderClosed(orderID, hasTakeaway) {
    // Close the modal
    const modal = document.querySelector('.order-modal');
    if (modal) {
        modal.remove();
    }

    // Show message if takeaway
    if (hasTakeaway) {
        alert('Order closed. Table is in "clearing" state - release it when takeaway items are delivered.');
    }

    // Refresh the orders page
    if (window.location.pathname.includes('/orders')) {
        location.reload();
    }
}

function releaseTable(tableID) {
    if (!confirm('Release this table? This will mark the table as available.')) {
        return;
    }

    fetch(`/release-table/${tableID}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'HX-Request': 'true'
        }
    })
    .then(res => {
        if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
        }
        // Close the modal
        const modal = document.querySelector('.order-modal');
        if (modal) {
            modal.remove();
        }
        // Refresh the page
        location.reload();
    })
    .catch(err => {
        console.error('Error releasing table:', err);
        alert('Failed to release table. Please try again.');
    });
}

// SSE handler for order modal updates - using HTMX events directly
console.log('[Order Modal] Script loaded and event listener being registered');

document.body.addEventListener('htmx:sseMessage', function(evt) {
    console.log('[Order Modal] htmx:sseMessage event received:', evt);
    console.log('[Order Modal] Event detail:', evt.detail);
    console.log('[Order Modal] Event type:', evt.detail?.type);

    // Only process if this event is for order-item-update
    if (evt.detail && evt.detail.type === 'order-item-update') {
        console.log('[Order Modal] ‚úÖ Processing order-item-update event');

        const modal = document.querySelector('.order-modal');
        console.log('[Order Modal] Modal found:', modal);
        if (!modal) {
            console.log('[Order Modal] ‚ùå No modal found, exiting');
            return;
        }

        // Get the HTML directly from the event data instead of waiting for HTMX to insert it
        const htmlData = evt.detail.data;
        console.log('[Order Modal] HTML data from event:', htmlData?.substring(0, 200));
        if (!htmlData) {
            console.log('[Order Modal] ‚ùå No data in event, exiting');
            return;
        }

        // Parse the HTML to extract the order item row
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlData;
        const newItemRow = tempDiv.querySelector('.order-item-row');
        console.log('[Order Modal] New item row parsed from HTML:', newItemRow);
        if (!newItemRow) {
            console.log('[Order Modal] ‚ùå No order-item-row found in event data, exiting');
            return;
        }

        const orderItemID = newItemRow.dataset.itemId;
        console.log('[Order Modal] Order item ID:', orderItemID);
        if (!orderItemID) {
            console.log('[Order Modal] ‚ùå No item ID found, exiting');
            return;
        }

        // Log the status information from the new row
        const newStatus = newItemRow.dataset.status;
        const newStatusLabel = newItemRow.querySelector('.order-item-status')?.textContent;
        const newStatusClass = newItemRow.querySelector('.order-item-status')?.className;
        console.log('[Order Modal] New row status:', newStatus);
        console.log('[Order Modal] New row status label TEXT:', newStatusLabel);
        console.log('[Order Modal] New row status label CLASS:', newStatusClass);

        // Find ALL existing rows with this ID (check for duplicates)
        const allExistingRows = modal.querySelectorAll(`.order-item-row[data-item-id="${orderItemID}"]`);
        console.log('[Order Modal] üîç Total elements with this ID:', allExistingRows.length);

        if (allExistingRows.length === 0) {
            console.log('[Order Modal] ‚ö†Ô∏è No existing row found for item ID:', orderItemID);
            return;
        }

        // Replace ALL instances (in case there are duplicates)
        allExistingRows.forEach((existingRow, index) => {
            console.log(`[Order Modal] Processing row ${index + 1} of ${allExistingRows.length}`);

            // Log old status info
            const oldStatus = existingRow.dataset.status;
            const oldStatusLabel = existingRow.querySelector('.order-item-status')?.textContent;
            console.log('[Order Modal] Old row status:', oldStatus);
            console.log('[Order Modal] Old row status label TEXT:', oldStatusLabel);

            console.log('[Order Modal] ‚úÖ Replacing row with new content using replaceWith()');
            console.log('[Order Modal] Old HTML:', existingRow.outerHTML.substring(0, 100));
            console.log('[Order Modal] New HTML:', newItemRow.outerHTML.substring(0, 100));

            // Use replaceWith() instead of outerHTML for better browser compatibility
            existingRow.replaceWith(newItemRow.cloneNode(true));
            console.log('[Order Modal] ‚úÖ Row replacement complete');
        });

        // Verify the replacement worked
        const updatedRow = modal.querySelector(`.order-item-row[data-item-id="${orderItemID}"]`);
        if (updatedRow) {
            const updatedStatus = updatedRow.dataset.status;
            const updatedStatusLabel = updatedRow.querySelector('.order-item-status')?.textContent;
            console.log('[Order Modal] AFTER replacement - status:', updatedStatus);
            console.log('[Order Modal] AFTER replacement - status label:', updatedStatusLabel);
            console.log('[Order Modal] AFTER replacement - element visible?', updatedRow.offsetParent !== null);
            console.log('[Order Modal] AFTER replacement - element in DOM?', document.contains(updatedRow));
        } else {
            console.log('[Order Modal] ‚ùå ERROR: Element disappeared after replacement!');
        }
    } else {
        console.log('[Order Modal] Event is not order-item-update, ignoring');
    }
});

console.log('[Order Modal] Event listener registered successfully');
</script>
{{end}}
